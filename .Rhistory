if(sum(SepData$Separations) == 0){
warning('No hospital separations available for ', .p$name,
' in age group ', .a,
' in year ', year,
' or any other year for which data is available',
'. Trying mean LOS in all age groups in other years for which data is available to estimate time off work for this agegroup and year')
SepData <- subset(Hospitalisations, DC4D %in% .p$hospCode)
if(sum(SepData$Separations) == 0){
stop('No hospital separations available for ', .p$name,
' in any age group',
' in year ', year,
' or any other year for which data is available.')
}
}
}
}
meanLOS <- sum(SepData$PatientDays)/sum(SepData$Separations)
CarerDays <- subset(MissedDaysGastro, AgeGroup == .a & Type == "Carer")$estimate.mu +
meanLOS *
Workforce['15-64', 'PropInWorkforce'] *
Workforce[.a, 'PropNeedsCarer'] * 5/7
SelfDays <- subset(MissedDaysGastro, AgeGroup == .a & Type == "Self")$estimate.mu +
meanLOS *
Workforce[.a, 'PropInWorkforce'] * 5/7
list(CarerDays =CarerDays, SelfDays = SelfDays)
})
}) %>%
rapply(enquote,how = "unlist") %>% #make a dataframe (very wide)
lapply(eval) %>%
as.data.frame(check.names = F) %>%
pivot_longer(everything(),
names_sep = "\\.",
names_to = c('Pathogen', "AgeGroup",'Kind')) %>%
mutate(value = as.character(round(value,digits = 1))) %>%
pivot_wider(Pathogen,names_from = c('Kind','AgeGroup'),names_sort = T) %>%
as.data.frame() %>%
`rownames<-`(.$Pathogen) %>%
`[`(c("All gastro pathogens","Campylobacter","Listeria monocytogenes",
"Non-typhoidal salmonella","Shigella","STEC",
"Escherichia coli (Non-STEC)","Salmonella Typhi",
"Yersinia Enterocolitica","Toxoplasma gondii","Norovirus"),)
write_excel_csv(TimeOffWork,'./Report/LostDaysPaidWork.csv')
### Australia UK WTP comparisons
WTPValues <- data.frame(Disease = c('Gastroenteritis', 'Campylobacteriosis', 'Salmonellosis',
'GBS','ReactiveArthritis','IBS'),
UK = c(124,159,159,15617,3263,28125),
Aus = c(33,138,138,1371,717,530))
WTPComparions <- EpiTable %>%
subset(Pathogen %in% c("Non-typhoidal salmonella", 'Campylobacter', 'All gastro pathogens') &
AgeGroup == 'All Ages' &
Measure == 'Cases' &
Disease != 'Initial and Sequel Disease' &
(Disease == 'Gastroenteritis' | Pathogen != "All gastro pathogens")
) %>%
select(-c(AgeGroup, Measure)) %>%
merge(WTPValues, all = T) %>%
mutate(across(UK:Aus, ~.x * median)) %>%
select(Pathogen, Disease, UK, Aus)
bind_rows(subset(WTPComparions, !(Disease %in% SequelaeNames) ),
group_by(WTPComparions,Pathogen) %>%
summarise(across(UK:Aus, ~sum(.x)))
) %>%
mutate(across(UK:Aus,~format(signif(.x/10^6,3),
big.mark = ",",
scientific = FALSE,
nsmall = 0,
trim = T,
drop0trailing = TRUE))) %>%
write_excel_csv("./Report/WTPUKComparison.csv")
HospMultiplier <- map(AgeGroups, ~{
(HospList$`All gastro pathogens`$Gastroenteritis[[.x]] /
IncidenceList$`All gastro pathogens`$Gastroenteritis[[.x]])/
(HospList$`Escherichia coli (Non-STEC)`$`Escherichia coli (Non-STEC)`[[.x]]/
IncidenceList$`Escherichia coli (Non-STEC)`$`Escherichia coli (Non-STEC)`[[.x]])
})
CostList.Ecoli.Sensitivity <- map(AgeGroups,~{
out <- CostList$`Escherichia coli (Non-STEC)`$`Escherichia coli (Non-STEC)`[[.x]]
out$Hospitalisation <- out$Hospitalisation * HospMultiplier[[.x]]
out
})
CostList.Ecoli.Sensitivity <- do.call(add,unname(CostList.Ecoli.Sensitivity)) %>%
`[`(c('GPSpecialist','ED','Medications','Tests','Hospitalisation','Deaths',
'WTP','HumanCapital'))
CostList.Ecoli.Sensitivity$TotalHumanCaptial <- reduce(CostList.Ecoli.Sensitivity, `+`)
CostSummary.Ecoli.Sensitivity <- CostList.Ecoli.Sensitivity %>%
quantilesNestedList(1,names_to = c('CostItem'))
CostSummary.Ecoli.Sensitivity
source('./Outbreak.R')
ndraws <- 10^5
set.seed(20220222)
writeOutbreakTable <- function(Outbreak,OutbreakEst,filename){
CostSummary <- summariseCostList(list(Outbreak = OutbreakEst$costs))$Detailed %>%
subset(AgeGroup == 'All Ages' &
!(Disease %in% c('Initial and Sequel Disease', SequelaeNames))) %>% #only interested in initial disease costs for the report
as.data.frame
CostSummary %>%
select(CostItem, median, X5. = `5%`, X95. = `95%`) %>%
medianCIformat(unit = 1,newline = FALSE) %>%
select(CostItem, Cost) %>%
`rownames<-`(.$CostItem) %>%
`[`(c('GPSpecialist','ED','Hospitalisation','Tests','Medications','HumanCapital',
'WTP','Deaths','TotalHumanCapital'),) %>%
write_excel_csv(paste0('./Report/',filename,'OutbreakCosts.csv'))
# Write list of GP, Specialist, ED and Hospital Visits
OutbreakCases <- OutbreakEst$cases[[1]] %>% reduce(`+`) #sum across agegroups
OutbreakHosp <- OutbreakEst$separations[[1]] %>% reduce(`+`) #sum across agegroups
GPSpecialist <- estimateGPSpecialist(Outbreak,
cases = OutbreakCases,
separations = OutbreakHosp,
ndraws = ndraws) %>%
`$<-`('GP',.$gpShort + .$gpLong) %>% #sum over types of gp or specialist visits
`$<-`('Specialist',.$specialistInitial + .$specialistRepeat) %>%
`[`(c('GP','Specialist','physio'))
ED <- estimateGeneric(Outbreak['ed'],ndraws = ndraws,
OutbreakEst$cases[[1]] %>%reduce(`+`)) # sum across agegroups
c(GPSpecialist,ED, list(Hospitalisations = OutbreakHosp)) %>%
quantilesNestedList(1, "CostItem") %>%
rename(X5. = '5%',X95. = '95%') %>%
medianCIformat(newline = FALSE, unit = 1) %>%
select(CostItem, Cost) %>%
write_excel_csv(paste0('./Report/',filename,'OutbreakMedicalPresentations.csv'))
}
ListeriaOutbreak <- PathogenAssumptions$`Listeria monocytogenes`
ListeriaOutbreak$domestic <- rdist("discrete", value = 1,  continuous = FALSE)
ListeriaOutbreak.notifications <- list(`<5` = 0, `5-64` = 22-10, `65+` = 10) #We are assuming 10 cases were 65+ and the remainder 5-64
ListeriaOutbreak.deaths <- list(`<5` = 1, `5-64` = 7, `65+` = 0) #7 deaths (assumed to be 5-64) and one miscarriage (costed as an additional death)
ListeriaOutbreak.Est <- costOutbreak(ListeriaOutbreak, ndraws = ndraws,
notifications = ListeriaOutbreak.notifications,
deaths = list(Listeriosis = ListeriaOutbreak.deaths))
writeOutbreakTable(ListeriaOutbreak,ListeriaOutbreak.Est,'Listeria')
EnteritidisOutbreak <- PathogenAssumptions$`Non-typhoidal salmonella`
EnteritidisOutbreak$domestic <- rdist("discrete", value = 1,  continuous = FALSE)
EnteritidisOutbreak.notifications <- list(`<5` = 0, `5-64` = 235, `65+` = 0)
EnteritidisOutbreak.deaths <- list(`<5` = 0, `5-64` = 1, `65+` = 0)
EnteritidisOutbreak.Est <- costOutbreak(EnteritidisOutbreak,ndraws = ndraws,
notifications = EnteritidisOutbreak.notifications,
deaths = list(Salmonellosis = EnteritidisOutbreak.deaths))
writeOutbreakTable(EnteritidisOutbreak,EnteritidisOutbreak.Est,'Enteritidis')
##################################################
#######Salmonella Weltevreden in eggs (2019)######
##################################################
WeltevredenOutbreak <- PathogenAssumptions$`Non-typhoidal salmonella`
WeltevredenOutbreak$domestic <- rdist("discrete", value = 1,  continuous = FALSE)
WeltevredenOutbreak.notifications <- list(`<5` = 0, `5-64` = 83, `65+` = 0)
WeltevredenOutbreak.deaths <- list(`<5` = 0, `5-64` = 0, `65+` = 0)
WeltevredenOutbreak.Est <- costOutbreak(WeltevredenOutbreak, ndraws = ndraws,
notifications = WeltevredenOutbreak.notifications,
deaths = list(Salmonellosis = WeltevredenOutbreak.deaths))
writeOutbreakTable(WeltevredenOutbreak,WeltevredenOutbreak.Est,'Weltevreden')
TyphimuriumOutbreak <- PathogenAssumptions$`Non-typhoidal salmonella`
TyphimuriumOutbreak$ed <- rdist('discrete', value = 58/203, continuous = FALSE)
TyphimuriumOutbreak$domestic <- rdist("discrete", value = 1, continuous = FALSE)
TyphimuriumOutbreak$foodborne <- rdist("discrete", value = 1, continuous = FALSE)
TyphimuriumOutbreak$underreporting <- rdist("discrete", value = 203/91, continuous = FALSE)
warning('In the document we specifically say that LOS was 5 days, but this is not reflected in our costing in any way')
TyphimuriumOutbreak.notifications <- list(`<5` = 0, `5-64` = 91, `65+` = 0)
TyphimuriumOutbreak.separations <- list(`<5` = 0, `5-64` = 32, `65+` = 0)
TyphimuriumOutbreak.deaths <- list(`<5` = 0, `5-64` = 0, `65+` = 0)
TyphimuriumOutbreak.Est <- costOutbreak(TyphimuriumOutbreak, ndraws = ndraws,
notifications = TyphimuriumOutbreak.notifications,
separations = list(Salmonellosis = TyphimuriumOutbreak.separations),
deaths = list(Salmonellosis = TyphimuriumOutbreak.deaths))
writeOutbreakTable(TyphimuriumOutbreak,TyphimuriumOutbreak.Est,'Typhimurium')
writeOutbreakTable(WeltevredenOutbreak,WeltevredenOutbreak.Est,'Weltevreden')
read.csv('Outputs/EpiTable.csv')
EpiMeasures.Ordered <- c("Cases",'Hospitalisations', 'Deaths')
EpiMeasures.Ordered <- c("Cases",'Hospitalisations', 'Deaths')
read.csv('Outputs/EpiTable.csv') %>%
select(-X) %>%
mutate(Disease = ifelse(Disease == unlist(map(PathogenAssumptions, ~.x$name))[Pathogen],
'Initial Disease',
Disease)) %>%
subset(Pathogen %in% PathogensWithSequelae | Disease == 'Initial Disease') %>%
#subset(Disease %in% Diseases.Ordered) %>%
#mutate(Disease = factor(Disease, levels = Diseases.Ordered)) %>%
group_by(Pathogen, Disease) %>%
group_walk(~{
.x %>%
subset(Measure %in% EpiMeasures.Ordered) %>%
medianCIformat %>%
mutate(Measure = factor(Measure, levels = EpiMeasures.Ordered)) %>%
select(AgeGroup, CostItem, Cost) %>%
pivot_wider(names_from = AgeGroup, values_from = Cost) %>%
arrange(Measure) %>%
subset(`All Ages` != '0') %>%
write_excel_csv(paste('Report/EpiTable',
paste(.y,collapse = '.'),
'csv',sep = '.'))
})
read.csv('Outputs/EpiTable.csv') %>%
select(-X) %>%
mutate(Disease = ifelse(Disease == unlist(map(PathogenAssumptions, ~.x$name))[Pathogen],
'Initial Disease',
Disease)) %>%
subset(Pathogen %in% PathogensWithSequelae | Disease == 'Initial Disease') %>%
#subset(Disease %in% Diseases.Ordered) %>%
#mutate(Disease = factor(Disease, levels = Diseases.Ordered)) %>%
group_by(Pathogen, Disease) %>%
group_walk(~{
.x %>%
subset(Measure %in% EpiMeasures.Ordered) %>%
medianCIformat %>%
mutate(Measure = factor(Measure, levels = EpiMeasures.Ordered)) %>%
select(AgeGroup, Measure, Cost) %>%
pivot_wider(names_from = AgeGroup, values_from = Cost) %>%
arrange(Measure) %>%
subset(`All Ages` != '0') %>%
write_excel_csv(paste('Report/EpiTable',
paste(.y,collapse = '.'),
'csv',sep = '.'))
})
x <- read.csv('Outputs/EpiTable.csv')
View(x)
x %>% subset(AgeGroup == 'All Ages')
x %>% subset(AgeGroup == 'All Ages') %>% View
EpiMeasures.Ordered <- c("Cases",'Hospitalisations', 'Deaths')
read.csv('Outputs/EpiTable.csv') %>%
select(-X) %>%
mutate(Disease = ifelse(Disease == unlist(map(PathogenAssumptions, ~.x$name))[Pathogen],
'Initial Disease',
Disease)) %>%
subset(Pathogen %in% PathogensWithSequelae | Disease == 'Initial Disease') %>%
#subset(Disease %in% Diseases.Ordered) %>%
#mutate(Disease = factor(Disease, levels = Diseases.Ordered)) %>%
group_by(Pathogen, Disease) %>%
group_walk(~{
.x %>%
subset(Measure %in% EpiMeasures.Ordered) %>%
medianCIformat %>%
mutate(Measure = factor(Measure, levels = EpiMeasures.Ordered)) %>%
select(AgeGroup, Measure, Cost) %>%
pivot_wider(names_from = AgeGroup, values_from = Cost) %>%
arrange(Measure) %>%
subset(`All Ages` != '0') %>%
write_excel_csv(paste('Report/EpiTable',
paste(.y,collapse = '.'),
'csv',sep = '.'))
})
read.csv('Outputs/EpiTable.csv') %>%
select(-X) %>%
mutate(Disease = ifelse(Disease == unlist(map(PathogenAssumptions, ~.x$name))[Pathogen],
'Initial Disease',
Disease)) %>%
subset(Pathogen %in% PathogensWithSequelae | Disease == 'Initial Disease') %>%
#subset(Disease %in% Diseases.Ordered) %>%
#mutate(Disease = factor(Disease, levels = Diseases.Ordered)) %>%
group_by(Pathogen, Disease) %>%
group_walk(~{
.x %>%
subset(Measure %in% EpiMeasures.Ordered) %>%
medianCIformat(unit = 1) %>%
mutate(Measure = factor(Measure, levels = EpiMeasures.Ordered)) %>%
select(AgeGroup, Measure, Cost) %>%
pivot_wider(names_from = AgeGroup, values_from = Cost) %>%
arrange(Measure) %>%
subset(`All Ages` != '0') %>%
write_excel_csv(paste('Report/EpiTable',
paste(.y,collapse = '.'),
'csv',sep = '.'))
})
signif(1)
signif(1.1234124124123)
signif(1.0000000000)
ifelse(.x<100, round(.x,digits = 0),signif(.x,3))
ifelse(runif(100) *2<100, round(.x,digits = 0),signif(.x,3))
function(.x){ifelse(.x<100, round(.x,digits = 0),signif(.x,3))}
f <- function(.x){ifelse(.x<100, round(.x,digits = 0),signif(.x,3))}
f(runif(1000) * 200)
f(runif(1000) * 2000)
f <- function(.x){ifelse(.x<100 & FALSE, round(.x,digits = 0),signif(.x,3))}
f(runif(1000) * 2000)
f <- function(.x){format(ifelse(.x<100 & FALSE, round(.x,digits = 0),signif(.x,3)), big.mark = ",",
scientific = FALSE,
nsmall = 0,
trim = T,
drop0trailing = TRUE)}
f(runif(1000) * 2000)
f <- function(.x,round = FALSE){format(ifelse(.x<100 & round, round(.x,digits = 0),signif(.x,3)), big.mark = ",",
scientific = FALSE,
nsmall = 0,
trim = T,
drop0trailing = TRUE)}
f(runif(1000) * 2000)
f(runif(1000) * 2000,T)
f(runif(1000) * 2000,F)
medianCIformat <- function(df,unit = 1000,newline = TRUE,round = FALSE){
df %>%
mutate(across(c(X5.,X95.,median),~format(ifelse(.x<100 & round, round(.x,digits = 0),signif(.x,3)), #format to three significant figures (potentially rounding to closest integer)
big.mark = ",",
scientific = FALSE,
nsmall = 0,
trim = T,
drop0trailing = TRUE))) %>%
mutate(across(c(X5.,X95.),           #remove intervals when they are the same as the point estimate
~if_else(.x == median,
'',
.x))) %>%
mutate(Cost = if_else(X5. == '',  #merge cost and and interval into a single line
median,
paste0(median, ifelse(newline,'\n',' '), '(',X5.,' - ',X95.,')')))
}
EpiMeasures.Ordered <- c("Cases",'Hospitalisations', 'Deaths')
read.csv('Outputs/EpiTable.csv') %>%
select(-X) %>%
mutate(Disease = ifelse(Disease == unlist(map(PathogenAssumptions, ~.x$name))[Pathogen],
'Initial Disease',
Disease)) %>%
subset(Pathogen %in% PathogensWithSequelae | Disease == 'Initial Disease') %>%
#subset(Disease %in% Diseases.Ordered) %>%
#mutate(Disease = factor(Disease, levels = Diseases.Ordered)) %>%
group_by(Pathogen, Disease) %>%
group_walk(~{
.x %>%
subset(Measure %in% EpiMeasures.Ordered) %>%
medianCIformat(unit = 1,round = TRUE) %>%
mutate(Measure = factor(Measure, levels = EpiMeasures.Ordered)) %>%
select(AgeGroup, Measure, Cost) %>%
pivot_wider(names_from = AgeGroup, values_from = Cost) %>%
arrange(Measure) %>%
subset(`All Ages` != '0') %>%
write_excel_csv(paste('Report/EpiTable',
paste(.y,collapse = '.'),
'csv',sep = '.'))
})
1&0
medianCIformat <- function(df,unit = 1000,newline = TRUE,round = FALSE){
df %>%
mutate(across(c(X5.,X95.,median),~format(ifelse(.x<100 & round, round(.x,digits = round),signif(.x,3)), #format to three significant figures (potentially rounding to closest integer)
big.mark = ",",
scientific = FALSE,
nsmall = 0,
trim = T,
drop0trailing = TRUE))) %>%
mutate(across(c(X5.,X95.),           #remove intervals when they are the same as the point estimate
~if_else(.x == median,
'',
.x))) %>%
mutate(Cost = if_else(X5. == '',  #merge cost and and interval into a single line
median,
paste0(median, ifelse(newline,'\n',' '), '(',X5.,' - ',X95.,')')))
}
read.csv('Outputs/EpiTable.csv') %>%
select(-X) %>%
mutate(Disease = ifelse(Disease == unlist(map(PathogenAssumptions, ~.x$name))[Pathogen],
'Initial Disease',
Disease)) %>%
subset(Pathogen %in% PathogensWithSequelae | Disease == 'Initial Disease') %>%
#subset(Disease %in% Diseases.Ordered) %>%
#mutate(Disease = factor(Disease, levels = Diseases.Ordered)) %>%
group_by(Pathogen, Disease) %>%
group_walk(~{
.x %>%
subset(Measure %in% EpiMeasures.Ordered) %>%
medianCIformat(unit = 1,round = 1) %>%
mutate(Measure = factor(Measure, levels = EpiMeasures.Ordered)) %>%
select(AgeGroup, Measure, Cost) %>%
pivot_wider(names_from = AgeGroup, values_from = Cost) %>%
arrange(Measure) %>%
subset(`All Ages` != '0') %>%
write_excel_csv(paste('Report/EpiTable',
paste(.y,collapse = '.'),
'csv',sep = '.'))
})
medianCIformat <- function(df,unit = 1000,newline = TRUE,round = FALSE,dropnullinterval = TRUE){
df %>%
mutate(across(c(X5.,X95.,median),~format(ifelse(.x<100 & round, round(.x,digits = round),signif(.x,3)), #format to three significant figures (potentially rounding to closest integer)
big.mark = ",",
scientific = FALSE,
nsmall = 0,
trim = T,
drop0trailing = TRUE))) %>%
mutate(across(c(X5.,X95.),           #remove intervals when they are the same as the point estimate
~if_else(.x == median & dropnullinterval,
'',
.x))) %>%
mutate(Cost = if_else(X5. == '',  #merge cost and and interval into a single line
median,
paste0(median, ifelse(newline,'\n',' '), '(',X5.,' - ',X95.,')')))
}
read.csv('Outputs/EpiTable.csv') %>%
select(-X) %>%
mutate(Disease = ifelse(Disease == unlist(map(PathogenAssumptions, ~.x$name))[Pathogen],
'Initial Disease',
Disease)) %>%
subset(Pathogen %in% PathogensWithSequelae | Disease == 'Initial Disease') %>%
#subset(Disease %in% Diseases.Ordered) %>%
#mutate(Disease = factor(Disease, levels = Diseases.Ordered)) %>%
group_by(Pathogen, Disease) %>%
group_walk(~{
.x %>%
subset(Measure %in% EpiMeasures.Ordered) %>%
medianCIformat(unit = 1,round = 1,drop = FALSE) %>%
mutate(Measure = factor(Measure, levels = EpiMeasures.Ordered)) %>%
select(AgeGroup, Measure, Cost) %>%
pivot_wider(names_from = AgeGroup, values_from = Cost) %>%
arrange(Measure) %>%
subset(`All Ages` != '0') %>%
write_excel_csv(paste('Report/EpiTable',
paste(.y,collapse = '.'),
'csv',sep = '.'))
})
read.csv('Outputs/EpiTable.csv') %>%
select(-X) %>%
mutate(Disease = ifelse(Disease == unlist(map(PathogenAssumptions, ~.x$name))[Pathogen],
'Initial Disease',
Disease)) %>%
subset(Pathogen %in% PathogensWithSequelae | Disease == 'Initial Disease') %>%
#subset(Disease %in% Diseases.Ordered) %>%
#mutate(Disease = factor(Disease, levels = Diseases.Ordered)) %>%
group_by(Pathogen, Disease) %>%
group_walk(~{
.x %>%
subset(Measure %in% EpiMeasures.Ordered) %>%
medianCIformat(unit = 1,round = 1,drop = FALSE) %>%
mutate(Measure = factor(Measure, levels = EpiMeasures.Ordered)) %>%
select(AgeGroup, Measure, Cost) %>%
pivot_wider(names_from = AgeGroup, values_from = Cost) %>%
arrange(Measure) %>%
subset(`All Ages` != '0') %>%
write_excel_csv(paste('Report/EpiTable',
paste(.y,collapse = '.'),
'csv',sep = '.'))
})
medianCIformat <- function(df,unit = 1000,newline = TRUE,round = FALSE,digits.round = NULL,dropnullinterval = TRUE){
df %>%
mutate(across(c(X5.,X95.,median),~format(ifelse(.x<100 & round, round(.x,digits = digits.round),signif(.x,3)), #format to three significant figures (potentially rounding to closest integer)
big.mark = ",",
scientific = FALSE,
nsmall = 0,
trim = T,
drop0trailing = TRUE))) %>%
mutate(across(c(X5.,X95.),           #remove intervals when they are the same as the point estimate
~if_else(.x == median & dropnullinterval,
'',
.x))) %>%
mutate(Cost = if_else(X5. == '',  #merge cost and and interval into a single line
median,
paste0(median, ifelse(newline,'\n',' '), '(',X5.,' - ',X95.,')')))
}
EpiMeasures.Ordered <- c("Cases",'Hospitalisations', 'Deaths')
read.csv('Outputs/EpiTable.csv') %>%
select(-X) %>%
mutate(Disease = ifelse(Disease == unlist(map(PathogenAssumptions, ~.x$name))[Pathogen],
'Initial Disease',
Disease)) %>%
subset(Pathogen %in% PathogensWithSequelae | Disease == 'Initial Disease') %>%
#subset(Disease %in% Diseases.Ordered) %>%
#mutate(Disease = factor(Disease, levels = Diseases.Ordered)) %>%
group_by(Pathogen, Disease) %>%
group_walk(~{
.x %>%
subset(Measure %in% EpiMeasures.Ordered) %>%
medianCIformat(unit = 1,round = TRUE, digits.round = 0,drop = FALSE) %>%
mutate(Measure = factor(Measure, levels = EpiMeasures.Ordered)) %>%
select(AgeGroup, Measure, Cost) %>%
pivot_wider(names_from = AgeGroup, values_from = Cost) %>%
arrange(Measure) %>%
subset(`All Ages` != '0') %>%
write_excel_csv(paste('Report/EpiTable',
paste(.y,collapse = '.'),
'csv',sep = '.'))
})
load('AusFBDiseaseImage.RData')
library(tidyverse)
CostItems.Ordered <- c('GPSpecialist','ED','Hospitalisation','Tests','Medications',
'HumanCapital','WTP','Deaths','WTPOngoing','TotalHumanCapital')
Diseases.Ordered <- c("Initial Disease", "IBS", "ReactiveArthritis", "GBS", 'HUS')
medianCIformat <- function(df,unit = 1000,newline = TRUE,round = FALSE,digits.round = NULL,dropnullinterval = TRUE){
df %>%
mutate(across(c(X5.,X95.,median),~format(ifelse(.x/unit<100 & round, round(.x/unit,digits = digits.round),signif(.x/unit,3)), #format to three significant figures (potentially rounding to closest integer)
big.mark = ",",
scientific = FALSE,
nsmall = 0,
trim = T,
drop0trailing = TRUE))) %>%
mutate(across(c(X5.,X95.),           #remove intervals when they are the same as the point estimate
~if_else(.x == median & dropnullinterval,
'',
.x))) %>%
mutate(Cost = if_else(X5. == '',  #merge cost and and interval into a single line
median,
paste0(median, ifelse(newline,'\n',' '), '(',X5.,' - ',X95.,')')))
}
PathogensWithSequelae <- map(PathogenAssumptions,~ifelse(length(.x$sequelae),
.x$pathogen,
NA)) %>%
unlist(use.names = F) %>% `[`(.,!is.na(.))
EpiMeasures.Ordered <- c("Cases",'Hospitalisations', 'Deaths')
read.csv('Outputs/EpiTable.csv') %>%
select(-X) %>%
mutate(Disease = ifelse(Disease == unlist(map(PathogenAssumptions, ~.x$name))[Pathogen],
'Initial Disease',
Disease)) %>%
subset(Pathogen %in% PathogensWithSequelae | Disease == 'Initial Disease') %>%
#subset(Disease %in% Diseases.Ordered) %>%
#mutate(Disease = factor(Disease, levels = Diseases.Ordered)) %>%
group_by(Pathogen, Disease) %>%
group_walk(~{
.x %>%
subset(Measure %in% EpiMeasures.Ordered) %>%
medianCIformat(unit = 1,round = TRUE, digits.round = 0,drop = FALSE) %>%
mutate(Measure = factor(Measure, levels = EpiMeasures.Ordered)) %>%
select(AgeGroup, Measure, Cost) %>%
pivot_wider(names_from = AgeGroup, values_from = Cost) %>%
arrange(Measure) %>%
subset(`All Ages` != '0') %>%
write_excel_csv(paste('Report/EpiTable',
paste(.y,collapse = '.'),
'csv',sep = '.'))
})
help(formatCurrency)
VSL
